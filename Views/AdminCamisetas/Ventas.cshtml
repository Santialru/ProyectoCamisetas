@model IEnumerable<ProyectoCamisetas.Models.Venta>

@{
    ViewData["Title"] = "Ventas";

    var summary = ViewBag.Summary as ProyectoCamisetas.Models.VentasSummary
                  ?? new ProyectoCamisetas.Models.VentasSummary();

    int page = ViewBag.Page is int ? (int)ViewBag.Page : 1;
    int totalPages = ViewBag.TotalPages is int ? (int)ViewBag.TotalPages : 1;
    int pageSize = ViewBag.PageSize is int ? (int)ViewBag.PageSize : 20;

    DateOnly? desdeVal = ViewBag.Desde as DateOnly?;
    DateOnly? hastaVal = ViewBag.Hasta as DateOnly?;

    string sortVal = ViewBag.Sort as string ?? "fecha_desc";
    string? equipoVal = ViewBag.Equipo as string;
    string? temporadaVal = ViewBag.Temporada as string;
    ProyectoCamisetas.Models.Talla? tallaVal = ViewBag.Talla as ProyectoCamisetas.Models.Talla?;
    string? compradorVal = ViewBag.Comprador as string;

    var today = DateOnly.FromDateTime(DateTime.UtcNow);
    var last7 = today.AddDays(-6);
    var firstOfMonth = new DateOnly(today.Year, today.Month, 1);
}

<h1>Ventas</h1>

@{
    var undoJson = TempData["UndoVentaPayload"] as string;
}

@if (!string.IsNullOrEmpty(undoJson))
{
    <div class="alert alert-warning d-flex align-items-center justify-content-between">
        <div>Venta eliminada. ¿Querés deshacer esta acción?</div>

        <form asp-action="DeshacerVenta" method="post" class="mb-0 d-flex align-items-center gap-2">
            <input type="hidden" name="payload" value="@undoJson" />
            <input type="hidden" name="desde" value="@desdeVal?.ToString("yyyy-MM-dd")" />
            <input type="hidden" name="hasta" value="@hastaVal?.ToString("yyyy-MM-dd")" />
            <input type="hidden" name="equipo" value="@equipoVal" />
            <input type="hidden" name="temporada" value="@temporadaVal" />
            <input type="hidden" name="talla" value="@tallaVal" />
            <input type="hidden" name="comprador" value="@compradorVal" />
            <input type="hidden" name="sort" value="@sortVal" />
            @Html.AntiForgeryToken()

            <button type="submit" class="btn btn-sm undo-btn">Deshacer</button>

            <div class="col-auto d-grid">
                <a class="btn btn-success"
                   asp-controller="AdminCamisetas"
                   asp-action="Index">
                    Registrar venta
                </a>
            </div>
        </form>
    </div>
}

<!-- Resumen superior -->
<div class="row g-3 mb-3 ventas-summary">
    <div class="col-md-4">
        <div class="card h-100">
            <div class="card-body d-flex flex-column">
                <div class="text-muted">Recaudación total</div>
                <div class="display-6 fw-bold mt-1 d-block">
                    @summary.TotalRecaudado.ToString("C")
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card h-100">
            <div class="card-body">
                <div class="text-muted mb-1">Talles más vendidos</div>

                @if (summary.TopTalles != null && summary.TopTalles.Count > 0)
                {
                    <div class="badges-wrap">
                        @foreach (var t in summary.TopTalles)
                        {
                            <span class="badge bg-secondary">@t.talla (@t.cantidad)</span>
                        }
                    </div>
                }
                else
                {
                    <span class="text-muted">-</span>
                }

                <div class="border-top mt-2 pt-2 small text-muted">Cantidad de ventas</div>
                <div class="h5 mb-0">@summary.Cantidad</div>

                <div class="small text-muted mt-2">Ticket promedio</div>
                <div class="h5 mb-0">@summary.TicketPromedio.ToString("C")</div>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card h-100">
            <div class="card-body">
                <div class="text-muted mb-1">Equipos más vendidos</div>

                @if (summary.TopEquipos != null && summary.TopEquipos.Count > 0)
                {
                    <div class="badges-wrap">
                        @foreach (var e in summary.TopEquipos)
                        {
                            <span class="badge bg-secondary">@e.equipo (@e.cantidad)</span>
                        }
                    </div>
                }
                else
                {
                    <span class="text-muted">-</span>
                }

                <div class="border-top mt-2 pt-2 small text-muted">Precio máximo</div>
                <div class="h5 mb-0">@summary.PrecioMax.ToString("C")</div>

                <div class="small text-muted mt-2">Precio mínimo</div>
                <div class="h5 mb-0">@summary.PrecioMin.ToString("C")</div>
            </div>
        </div>
    </div>
</div>

<!-- Filtros y fechas -->
<form method="get" class="row g-2 align-items-end mb-3">
    <div class="col-6 col-sm-3 col-md-2">
        <label class="form-label">Desde</label>
        <input type="date"
               name="desde"
               value="@desdeVal?.ToString("yyyy-MM-dd")"
               class="form-control" />
    </div>

    <div class="col-6 col-sm-3 col-md-2">
        <label class="form-label">Hasta</label>
        <input type="date"
               name="hasta"
               value="@hastaVal?.ToString("yyyy-MM-dd")"
               class="form-control" />
    </div>

    <div class="col-12 col-sm-6 col-md-8">
        <div class="d-flex flex-wrap gap-2">
            <a class="btn btn-outline-light btn-sm"
               asp-action="Ventas"
               asp-route-desde="@today.ToString("yyyy-MM-dd")"
               asp-route-hasta="@today.ToString("yyyy-MM-dd")"
               asp-route-equipo="@equipoVal"
               asp-route-temporada="@temporadaVal"
               asp-route-talla="@tallaVal"
               asp-route-comprador="@compradorVal"
               asp-route-sort="@sortVal"
               asp-route-pageSize="@pageSize">
                Hoy
            </a>

            <a class="btn btn-outline-light btn-sm"
               asp-action="Ventas"
               asp-route-desde="@last7.ToString("yyyy-MM-dd")"
               asp-route-hasta="@today.ToString("yyyy-MM-dd")"
               asp-route-equipo="@equipoVal"
               asp-route-temporada="@temporadaVal"
               asp-route-talla="@tallaVal"
               asp-route-comprador="@compradorVal"
               asp-route-sort="@sortVal"
               asp-route-pageSize="@pageSize">
                Últimos 7 días
            </a>

            <a class="btn btn-outline-light btn-sm"
               asp-action="Ventas"
               asp-route-desde="@firstOfMonth.ToString("yyyy-MM-dd")"
               asp-route-hasta="@today.ToString("yyyy-MM-dd")"
               asp-route-equipo="@equipoVal"
               asp-route-temporada="@temporadaVal"
               asp-route-talla="@tallaVal"
               asp-route-comprador="@compradorVal"
               asp-route-sort="@sortVal"
               asp-route-pageSize="@pageSize">
                Este mes
            </a>

            <span class="text-muted small align-self-center">
                o usa las fechas personalizadas
            </span>
        </div>
    </div>

    <div class="col-12 col-sm-3 col-md-2">
        <label class="form-label">Equipo</label>
        <input type="text"
               name="equipo"
               value="@equipoVal"
               class="form-control"
               placeholder="Equipo" />
    </div>

    <div class="col-12 col-sm-3 col-md-2">
        <label class="form-label">Temporada</label>
        <input type="text"
               name="temporada"
               value="@temporadaVal"
               class="form-control"
               placeholder="Ej: 2024/25" />
    </div>

    <div class="col-12 col-sm-3 col-md-2">
        <label class="form-label">Talle</label>
        <select name="talla" class="form-select">
            <option value="">(Todos)</option>
            @foreach (ProyectoCamisetas.Models.Talla t in Enum.GetValues(typeof(ProyectoCamisetas.Models.Talla)))
            {
                <option value="@t" selected="@(tallaVal.HasValue && tallaVal.Value == t)">
                    @t
                </option>
            }
        </select>
    </div>

    <div class="col-12 col-sm-3 col-md-2">
        <label class="form-label">Comprador</label>
        <input type="text"
               name="comprador"
               value="@compradorVal"
               class="form-control"
               placeholder="Nombre" />
    </div>

    <div class="col-6 col-sm-3 col-md-2">
        <label class="form-label">Por página</label>
        <select name="pageSize" class="form-select">
            <option value="20" selected="@(pageSize == 20)">20</option>
            <option value="50" selected="@(pageSize == 50)">50</option>
            <option value="100" selected="@(pageSize == 100)">100</option>
        </select>
    </div>

    <div class="col-auto d-grid">
        <input type="hidden" name="sort" value="@sortVal" />
        <button type="submit" class="btn btn-primary">Filtrar</button>
    </div>

    <div class="col-auto d-grid">
        <a asp-action="Ventas" class="btn btn-secondary">Limpiar</a>
    </div>

    <div class="col-auto d-grid">
        <a class="btn btn-success"
           asp-action="ExportVentas"
           asp-route-desde="@desdeVal"
           asp-route-hasta="@hastaVal"
           asp-route-equipo="@equipoVal"
           asp-route-temporada="@temporadaVal"
           asp-route-talla="@tallaVal"
           asp-route-comprador="@compradorVal"
           asp-route-sort="@sortVal">
            Exportar CSV
        </a>
    </div>
</form>

<!-- Tabla de ventas -->
<div class="table-responsive">
    <table class="table table-dark table-hover table-sm align-middle table-sticky">
        <thead>
            <tr>
                <th>
                    <a class="link-light text-decoration-none"
                       asp-action="Ventas"
                       asp-route-desde="@desdeVal"
                       asp-route-hasta="@hastaVal"
                       asp-route-equipo="@equipoVal"
                       asp-route-temporada="@temporadaVal"
                       asp-route-talla="@tallaVal"
                       asp-route-comprador="@compradorVal"
                       asp-route-sort="@(sortVal == "equipo_asc" ? "equipo_desc" : "equipo_asc")"
                       asp-route-pageSize="@pageSize">
                        Producto
                    </a>
                </th>
                <th class="d-none d-sm-table-cell">Temporada</th>
                <th>
                    <a class="link-light text-decoration-none"
                       asp-action="Ventas"
                       asp-route-desde="@desdeVal"
                       asp-route-hasta="@hastaVal"
                       asp-route-equipo="@equipoVal"
                       asp-route-temporada="@temporadaVal"
                       asp-route-talla="@tallaVal"
                       asp-route-comprador="@compradorVal"
                       asp-route-sort="@(sortVal == "fecha_asc" ? "fecha_desc" : "fecha_asc")"
                       asp-route-pageSize="@pageSize">
                        Fecha
                    </a>
                </th>
                <th>
                    <a class="link-light text-decoration-none"
                       asp-action="Ventas"
                       asp-route-desde="@desdeVal"
                       asp-route-hasta="@hastaVal"
                       asp-route-equipo="@equipoVal"
                       asp-route-temporada="@temporadaVal"
                       asp-route-talla="@tallaVal"
                       asp-route-comprador="@compradorVal"
                       asp-route-sort="@(sortVal == "precio_asc" ? "precio_desc" : "precio_asc")"
                       asp-route-pageSize="@pageSize">
                        Precio
                    </a>
                </th>
                <th>
                    <a class="link-light text-decoration-none"
                       asp-action="Ventas"
                       asp-route-desde="@desdeVal"
                       asp-route-hasta="@hastaVal"
                       asp-route-equipo="@equipoVal"
                       asp-route-temporada="@temporadaVal"
                       asp-route-talla="@tallaVal"
                       asp-route-comprador="@compradorVal"
                       asp-route-sort="@(sortVal == "talla_asc" ? "talla_desc" : "talla_asc")"
                       asp-route-pageSize="@pageSize">
                        Talle
                    </a>
                </th>
                <th>
                    <a class="link-light text-decoration-none"
                       asp-action="Ventas"
                       asp-route-desde="@desdeVal"
                       asp-route-hasta="@hastaVal"
                       asp-route-equipo="@equipoVal"
                       asp-route-temporada="@temporadaVal"
                       asp-route-talla="@tallaVal"
                       asp-route-comprador="@compradorVal"
                       asp-route-sort="@(sortVal == "comprador_asc" ? "comprador_desc" : "comprador_asc")"
                       asp-route-pageSize="@pageSize">
                        Comprador
                    </a>
                </th>
                <th class="d-none d-md-table-cell">Observaciones</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            @if (Model != null)
            {
                foreach (var v in Model)
                {
                    <tr>
                        <td>
                            <a class="link-light text-decoration-underline"
                               asp-controller="Camisetas"
                               asp-action="Details"
                               asp-route-id="@v.CamisetaId">
                                @(v.ProductoNombre ?? v.Camiseta?.Nombre) (@v.Equipo)
                            </a>
                        </td>
                        <td class="d-none d-sm-table-cell">
                            @(v.Temporada ?? v.Camiseta?.Temporada)
                        </td>
                        <td>@v.FechaVenta.ToLocalTime().ToString("yyyy-MM-dd HH:mm")</td>
                        <td>@v.Precio.ToString("C")</td>
                        <td><span class="badge bg-info text-dark">@v.Talla</span></td>
                        <td class="text-break">
                            @(string.IsNullOrWhiteSpace(v.Comprador) ? "-" : v.Comprador)
                        </td>
                        <td class="text-break d-none d-md-table-cell">
                            @(string.IsNullOrWhiteSpace(v.Observaciones) ? "-" : v.Observaciones)
                        </td>
                        <td>
                            <form asp-action="UpdateVenta"
                                  method="post"
                                  class="d-inline-flex align-items-center gap-1 me-1">
                                <input type="hidden" name="id" value="@v.Id" />
                                <input type="hidden" name="page" value="@(page)" />
                                <input type="hidden" name="pageSize" value="@pageSize" />
                                <input type="hidden" name="desde" value="@desdeVal?.ToString("yyyy-MM-dd")" />
                                <input type="hidden" name="hasta" value="@hastaVal?.ToString("yyyy-MM-dd")" />
                                <input type="hidden" name="equipo" value="@equipoVal" />
                                <input type="hidden" name="temporada" value="@temporadaVal" />
                                <input type="hidden" name="talla" value="@tallaVal" />
                                <input type="hidden" name="sort" value="@sortVal" />
                                @Html.AntiForgeryToken()

                                <input type="text"
                                       name="comprador"
                                       value="@v.Comprador"
                                       class="form-control form-control-sm"
                                       placeholder="Comprador"
                                       style="max-width: 140px;" />

                                <input type="text"
                                       name="observaciones"
                                       value="@v.Observaciones"
                                       class="form-control form-control-sm d-none d-lg-inline"
                                       placeholder="Obs."
                                       style="max-width: 200px;" />

                                <button type="submit" class="btn btn-sm btn-outline-primary">
                                    Guardar
                                </button>
                            </form>

                            <button type="button"
                                    class="btn btn-sm btn-outline-danger"
                                    data-bs-toggle="modal"
                                    data-bs-target="#deleteVentaModal"
                                    data-id="@v.Id"
                                    data-page="@(page)"
                                    data-pagesize="@pageSize"
                                    data-desde="@desdeVal?.ToString("yyyy-MM-dd")"
                                    data-hasta="@hastaVal?.ToString("yyyy-MM-dd")"
                                    data-equipo="@equipoVal"
                                    data-temporada="@temporadaVal"
                                    data-talla="@tallaVal"
                                    data-comprador="@compradorVal"
                                    data-sort="@sortVal">
                                Eliminar
                            </button>
                        </td>
                    </tr>
                }
            }
        </tbody>
    </table>
</div>

<!-- Paginación -->
<nav aria-label="Paginación" class="mt-3">
    <ul class="pagination pagination-sm">
        <li class="page-item @(page <= 1 ? "disabled" : null)">
            <a class="page-link"
               asp-action="Ventas"
               asp-route-desde="@desdeVal"
               asp-route-hasta="@hastaVal"
               asp-route-equipo="@equipoVal"
               asp-route-temporada="@temporadaVal"
               asp-route-talla="@tallaVal"
               asp-route-comprador="@compradorVal"
               asp-route-sort="@sortVal"
               asp-route-page="@(page - 1)"
               asp-route-pageSize="@pageSize">
                Anterior
            </a>
        </li>

        @for (int p = 1; p <= totalPages; p++)
        {
            <li class="page-item @(p == page ? "active" : null)">
                <a class="page-link"
                   asp-action="Ventas"
                   asp-route-desde="@desdeVal"
                   asp-route-hasta="@hastaVal"
                   asp-route-equipo="@equipoVal"
                   asp-route-temporada="@temporadaVal"
                   asp-route-talla="@tallaVal"
                   asp-route-comprador="@compradorVal"
                   asp-route-sort="@sortVal"
                   asp-route-page="@p"
                   asp-route-pageSize="@pageSize">
                    @p
                </a>
            </li>
        }

        <li class="page-item @(page >= totalPages ? "disabled" : null)">
            <a class="page-link"
               asp-action="Ventas"
               asp-route-desde="@desdeVal"
               asp-route-hasta="@hastaVal"
               asp-route-equipo="@equipoVal"
               asp-route-temporada="@temporadaVal"
               asp-route-talla="@tallaVal"
               asp-route-comprador="@compradorVal"
               asp-route-sort="@sortVal"
               asp-route-page="@(page + 1)"
               asp-route-pageSize="@pageSize">
                Siguiente
            </a>
        </li>
    </ul>
</nav>

<div class="modal fade" id="deleteVentaModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Eliminar venta</h5>
                <button type="button"
                        class="btn-close"
                        data-bs-dismiss="modal"
                        aria-label="Close">
                </button>
            </div>
            <div class="modal-body">¿Eliminar la venta y restablecer el stock?</div>
            <div class="modal-footer">
                <button type="button"
                        class="btn btn-secondary"
                        data-bs-dismiss="modal">
                    Cancelar
                </button>

                <form id="deleteVentaForm"
                      asp-action="EliminarVenta"
                      method="post"
                      class="d-inline">
                    <input type="hidden" name="id" />
                    <input type="hidden" name="page" value="@(page)" />
                    <input type="hidden" name="pageSize" value="@pageSize" />
                    <input type="hidden" name="desde" value="@desdeVal?.ToString("yyyy-MM-dd")" />
                    <input type="hidden" name="hasta" value="@hastaVal?.ToString("yyyy-MM-dd")" />
                    <input type="hidden" name="equipo" value="@equipoVal" />
                    <input type="hidden" name="temporada" value="@temporadaVal" />
                    <input type="hidden" name="talla" value="@tallaVal" />
                    <input type="hidden" name="comprador" value="@compradorVal" />
                    <input type="hidden" name="sort" value="@sortVal" />
                    @Html.AntiForgeryToken()

                    <button type="submit" class="btn btn-danger">
                        Eliminar
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    const delModal = document.getElementById('deleteVentaModal');
    if (delModal) {
        delModal.addEventListener('show.bs.modal', event => {
            const btn = event.relatedTarget;
            if (!btn) return;
            const id = btn.getAttribute('data-id');
            delModal.querySelector('input[name="id"]').value = id;
        });
    }
</script>

<!-- Gr�ficos -->
<div class="row g-3 mb-3">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <h6 class="card-title text-muted mb-2">Ventas por día</h6>
                <canvas id="ventasDiaChart" height="80"></canvas>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-body">
                <h6 class="card-title text-muted mb-2">Top equipos</h6>
                <canvas id="topEquiposChart" height="140"></canvas>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-body">
                <h6 class="card-title text-muted mb-2">Top talles</h6>
                <canvas id="topTallesChart" height="140"></canvas>
            </div>
        </div>
    </div>
</div>

<style>
    /* Evita superposici�n del monto con la etiqueta */
    .ventas-summary .card-body {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        justify-content: flex-start;
        row-gap: .5rem;
    }

    .ventas-summary .text-muted {
        margin-bottom: .5rem;
        line-height: 1.2;
        white-space: normal;
        overflow: visible;
        text-overflow: clip;
    }

    .ventas-summary .display-6 {
        display: block;
        line-height: 1.2;
        margin-top: .5rem !important;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .ventas-summary .badges-wrap {
        display: flex;
        flex-wrap: wrap;
        gap: .25rem;
        margin-top: .75rem;
    }

    .ventas-summary .badge {
        white-space: nowrap;
    }
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const ventasDiaLabels = [
        @Html.Raw(string.Join(",", (summary.VentasPorDia ?? new List<(DateOnly fecha, int cantidad)>())
            .Select(x => "'" + x.fecha.ToString("yyyy-MM-dd") + "'")))
    ];

    const ventasDiaData = [
        @string.Join(",", (summary.VentasPorDia ?? new List<(DateOnly fecha, int cantidad)>())
            .Select(x => x.cantidad))
    ];

    const topEqLabels = [
        @Html.Raw(string.Join(",", (summary.TopEquipos ?? new List<(string equipo, int cantidad)>())
            .Select(x => "'" + (x.equipo ?? string.Empty).Replace("'", "\\'") + "'")))
    ];

    const topEqData = [
        @string.Join(",", (summary.TopEquipos ?? new List<(string equipo, int cantidad)>())
            .Select(x => x.cantidad))
    ];

    const topTaLabels = [
        @Html.Raw(string.Join(",", (summary.TopTalles ?? new List<(ProyectoCamisetas.Models.Talla talla, int cantidad)>())
            .Select(x => "'" + x.talla.ToString() + "'")))
    ];

    const topTaData = [
        @string.Join(",", (summary.TopTalles ?? new List<(ProyectoCamisetas.Models.Talla talla, int cantidad)>())
            .Select(x => x.cantidad))
    ];

    if (document.getElementById('ventasDiaChart')) {
        const ctx1 = document.getElementById('ventasDiaChart').getContext('2d');
        new Chart(ctx1, {
            type: 'line',
            data: {
                labels: ventasDiaLabels,
                datasets: [{
                    label: 'Ventas',
                    data: ventasDiaData,
                    borderColor: '#0d6efd',
                    backgroundColor: 'rgba(13,110,253,.2)',
                    fill: true,
                    tension: .2
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { display: false } },
                scales: {
                    x: { ticks: { color: '#b8c2d9' } },
                    y: {
                        ticks: { color: '#b8c2d9' },
                        beginAtZero: true
                    }
                }
            }
        });
    }

    if (document.getElementById('topEquiposChart')) {
        const ctx2 = document.getElementById('topEquiposChart').getContext('2d');
        new Chart(ctx2, {
            type: 'bar',
            data: {
                labels: topEqLabels,
                datasets: [{
                    label: 'Ventas',
                    data: topEqData,
                    backgroundColor: 'rgba(220,53,69,.6)'
                }]
            },
            options: {
                indexAxis: 'y',
                plugins: { legend: { display: false } },
                scales: {
                    x: {
                        ticks: { color: '#b8c2d9' },
                        beginAtZero: true
                    },
                    y: { ticks: { color: '#b8c2d9' } }
                }
            }
        });
    }

    if (document.getElementById('topTallesChart')) {
        const ctx3 = document.getElementById('topTallesChart').getContext('2d');
        new Chart(ctx3, {
            type: 'bar',
            data: {
                labels: topTaLabels,
                datasets: [{
                    label: 'Ventas',
                    data: topTaData,
                    backgroundColor: 'rgba(13,110,253,.6)'
                }]
            },
            options: {
                plugins: { legend: { display: false } },
                scales: {
                    x: { ticks: { color: '#b8c2d9' } },
                    y: {
                        ticks: { color: '#b8c2d9' },
                        beginAtZero: true
                    }
                }
            }
        });
    }
</script>
