@model ProyectoCamisetas.ViewModels.CatalogoViewModel
@{
    ViewData["Title"] = "Catálogo";
}



@{
    var verSel = (string)Context.Request.Query["version"];
    var estSel = (string)Context.Request.Query["enStock"];
    var tallaSel = (string)Context.Request.Query["talla"];
    var sortSel = (string)Context.Request.Query["sort"];
    var prodSel = (string)Context.Request.Query["producto"];
}
<form method="get" class="row g-2 mb-3 align-items-stretch">
    <div class="col-12 col-lg">
        <input type="text" name="q" value="@Context.Request.Query["q"]" class="form-control" placeholder="Buscar por equipo, liga, nombre, temporada, marca, jugador... (ej: Barcelona, La Liga, 2024/25)" />
    </div>
    <div class="col-auto d-grid">
        <button class="btn btn-primary" type="submit">Buscar</button>
    </div>
    <div class="col-auto">
        <div class="dropdown" data-bs-auto-close="outside">
            <button class="btn btn-outline-primary dropdown-toggle" type="button" id="filtersDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                Filtros
            </button>
            <div class="dropdown-menu dropdown-menu-end p-3" aria-labelledby="filtersDropdown" style="min-width: 320px;">
                <div class="row g-2">
                    <div class="col-12">
                        <label class="form-label small mb-1">Versión</label>
                        <select class="form-select" name="version">
                            <option value="">Todas</option>
                            @if (verSel == "aficionado") { <option value="aficionado" selected>Aficionado</option> } else { <option value="aficionado">Aficionado</option> }
                            @if (verSel == "jugador") { <option value="jugador" selected>Jugador</option> } else { <option value="jugador">Jugador</option> }
                            @if (verSel == "retro") { <option value="retro" selected>Retro</option> } else { <option value="retro">Retro</option> }
                        </select>
                    </div>
                    <div class="col-12">
                        <label class="form-label small mb-1">Producto</label>
                        <select class="form-select" name="producto">
                            <option value="">Todos</option>
                            @if (prodSel == "camiseta") { <option value="camiseta" selected>Camiseta</option> } else { <option value="camiseta">Camiseta</option> }
                            @if (prodSel == "campera") { <option value="campera" selected>Campera</option> } else { <option value="campera">Campera</option> }
                            @if (prodSel == "short") { <option value="short" selected>Short</option> } else { <option value="short">Short</option> }
                            @if (prodSel == "conjunto") { <option value="conjunto" selected>Conjunto</option> } else { <option value="conjunto">Conjunto</option> }
                        </select>
                    </div>
                    <div class="col-12">
                        <label class="form-label small mb-1">Disponibilidad</label>
                        <select class="form-select" name="enStock">
                            <option value="">Todas</option>
                            @if (estSel == "true") { <option value="true" selected>En stock</option> } else { <option value="true">En stock</option> }
                            @if (estSel == "false") { <option value="false" selected>Por encargo</option> } else { <option value="false">Por encargo</option> }
                        </select>
                    </div>
                    <div class="col-12">
                        <label class="form-label small mb-1">Talle</label>
                        <select class="form-select" name="talla">
                            <option value="">Todos</option>
                            @if (tallaSel == "Ninos" || tallaSel == "Niños") { <option value="Ninos" selected>Niños</option> } else { <option value="Ninos">Niños</option> }
                            @if (tallaSel == "XS") { <option value="XS" selected>XS</option> } else { <option value="XS">XS</option> }
                            @if (tallaSel == "S") { <option value="S" selected>S</option> } else { <option value="S">S</option> }
                            @if (tallaSel == "M") { <option value="M" selected>M</option> } else { <option value="M">M</option> }
                            @if (tallaSel == "L") { <option value="L" selected>L</option> } else { <option value="L">L</option> }
                            @if (tallaSel == "XL") { <option value="XL" selected>XL</option> } else { <option value="XL">XL</option> }
                            @if (tallaSel == "XXL") { <option value="XXL" selected>XXL</option> } else { <option value="XXL">XXL</option> }
                        </select>
                    </div>
                    <div class="col-12">
                        <label class="form-label small mb-1">Precio</label>
                        <select class="form-select" name="sort">
                            <option value=""></option>
                            @if (sortSel == "price_asc") { <option value="price_asc" selected>Precio: menor a mayor</option> } else { <option value="price_asc">Precio: menor a mayor</option> }
                            @if (sortSel == "price_desc") { <option value="price_desc" selected>Precio: mayor a menor</option> } else { <option value="price_desc">Precio: mayor a menor</option> }
                        </select>
                    </div>
                </div>
                <div class="d-flex justify-content-end gap-2 mt-3">
                    <button type="submit" class="btn btn-primary btn-sm">Aplicar filtros</button>
                </div>
            </div>
        </div>
    </div>
    </form>

@{
    var hasFilters = !string.IsNullOrWhiteSpace(Context.Request.Query["q"]) 
        || !string.IsNullOrWhiteSpace(Context.Request.Query["liga"]) 
        || !string.IsNullOrWhiteSpace(Context.Request.Query["equipo"]) 
        || !string.IsNullOrWhiteSpace(Context.Request.Query["temporada"]) 
        || !string.IsNullOrWhiteSpace(Context.Request.Query["version"]) 
        || !string.IsNullOrWhiteSpace(Context.Request.Query["other"]) 
        || !string.IsNullOrWhiteSpace(Context.Request.Query["enStock"]) 
        || !string.IsNullOrWhiteSpace(Context.Request.Query["talla"]) 
        || !string.IsNullOrWhiteSpace(Context.Request.Query["sort"]);
}
@* Showcase eliminado: seccion destacados
<section class="showcase mb-4">
    <div class="d-flex justify-content-between align-items-end mb-2">
        <h2 class="m-0">Disponibles ahora</h2>
        <a class="link-light small" asp-controller="Camisetas" asp-action="Index">Ver todo</a>
    </div>
    <div class="showcase-track">
        @foreach (var c in Model.Destacadas)
        {
            var thumb = c.Imagenes?.OrderBy(x => x.Orden).FirstOrDefault()?.Url ?? c.ImagenUrl;
            var count = c.Imagenes?.Count ?? 0;
            if (count == 0 && !string.IsNullOrWhiteSpace(thumb)) { count = 1; }
            <a class="product-card" asp-action="Details" asp-route-id="@c.Id">
                <div class="product-image" style="background-image:url('@thumb')">
                    @if (count > 0)
                    {
                        <span class="photo-badge">@count fotos</span>
                    }
                    @if (c.PrecioAnterior.HasValue && c.PrecioAnterior.Value > c.Precio)
                    {
                        var pct = (int)Math.Round((c.PrecioAnterior.Value - c.Precio) / c.PrecioAnterior.Value * 100m);
                        <span class="discount-ribbon">-@pct%</span>
                    }
                </div>
                <div class="product-info">
                    <div class="product-top">
                        <span class="badge @(c.EsEdicionLimitada ? "bg-warning text-dark" : "bg-success")">En stock</span>
                        @if (c.EsEdicionLimitada) { <span class="badge bg-danger ms-1">EdiciÃ³n limitada</span> }
                    </div>
                    <h3>@c.Equipo <small class="text-muted">@c.Temporada</small></h3>
                    <p class="text-truncate m-0">@c.Nombre</p>
                    <div class="product-foot">
                        @if (c.PrecioAnterior.HasValue && c.PrecioAnterior.Value > c.Precio)
                        {
                            var pct = (int)Math.Round((c.PrecioAnterior.Value - c.Precio) / c.PrecioAnterior.Value * 100m);
                            <span>
                                <span class="price-old me-2">@c.PrecioAnterior.Value.ToString("C")</span>
                                <span class="price-new">@c.Precio.ToString("C")</span>
                                <span class="badge bg-danger ms-2 discount-badge">-@pct%</span>
                            </span>
                        }
                        else
                        {
                            <span class="price">@c.Precio.ToString("C")</span>
                        }
                        <span class="cta">Ver</span>
                    </div>
                </div>
            </a>
        }
    </div>
    @if (!Model.Destacadas.Any())
    {
        <div class="text-center text-muted py-4">No hay camisetas disponibles por ahora.</div>
    }
 </section>
*@

@{
    var disponibles = Model.Camisetas.Where(x => x.EnStock).ToList();
    var porEncargo = Model.Camisetas.Where(x => !x.EnStock).ToList();
}

@if (disponibles.Any())
{
    <section class="catalog-section mb-4">
        <div class="d-flex justify-content-between align-items-end mb-2">
            <h3 class="m-0">En Stock</h3>
        </div>
        <div class="row row-cols-1 row-cols-md-3 g-3">
    @foreach (var c in disponibles)
    {
        var thumb = c.Imagenes?.OrderBy(x => x.Orden).FirstOrDefault()?.Url ?? c.ImagenUrl;
        var count = c.Imagenes?.Count ?? 0;
        if (count == 0 && !string.IsNullOrWhiteSpace(thumb)) { count = 1; }
        <div class="col">
            <div class="card h-100 position-relative">
                @if (!string.IsNullOrWhiteSpace(thumb))
                {
                    <div class="image-wrap">
                        <img src="@thumb" class="card-img-top jersey-thumb" alt="@c.Nombre" />
                        @if (count > 0)
                        {
                            <span class="photo-badge">@count fotos</span>
                        }
                        @if (c.PrecioAnterior.HasValue && c.PrecioAnterior.Value > c.Precio)
                        {
                            var pct = (int)Math.Round((c.PrecioAnterior.Value - c.Precio) / c.PrecioAnterior.Value * 100m);
                            <span class="discount-ribbon">-@pct%</span>
                        }
                    </div>
                }
                <div class="card-body">
                    <div class="mb-2">
                        <span class="badge @(c.EsEdicionLimitada ? "bg-warning text-dark" : "bg-success")">@(c.EnStock ? "En stock" : "Encargala Ahora")</span>
                        @if (c.EsEdicionLimitada) { <span class="badge bg-danger ms-1">Edición limitada</span> }
                    </div>
                    <h5 class="card-title">@c.Equipo - @c.Temporada (@c.Tipo)</h5>
                    <p class="card-text">@c.Nombre<br/><small class="text-muted">@c.Liga - @c.Marca</small></p>
                    <div class="d-flex align-items-center justify-content-between mb-1">
                        <div>
                            @if (c.PrecioAnterior.HasValue && c.PrecioAnterior.Value > c.Precio)
                            {
                                <span class="price-old me-2">@c.PrecioAnterior.Value.ToString("C")</span>
                                <span class="price-new">@c.Precio.ToString("C")</span>
                            }
                            else
                            {
                                <span class="price-new">@c.Precio.ToString("C")</span>
                            }
                        </div>
                        <a class="btn btn-outline-primary btn-sm" asp-action="Details" asp-route-id="@c.Id">Ver detalles</a>
                    </div>
                    <a class="stretched-link" asp-action="Details" asp-route-id="@c.Id" aria-label="Ver detalles de @c.Nombre"></a>
                </div>
            </div>
        </div>
    }
        </div>
    </section>
}

@if (porEncargo.Any())
{
    <section class="catalog-section mb-4">
        <div class="d-flex justify-content-between align-items-end mb-2">
            <h3 class="m-0">Por Encargo</h3>
        </div>
        <div class="row row-cols-1 row-cols-md-3 g-3">
    @foreach (var c in porEncargo)
    {
        var thumb = c.Imagenes?.OrderBy(x => x.Orden).FirstOrDefault()?.Url ?? c.ImagenUrl;
        var count = c.Imagenes?.Count ?? 0;
        if (count == 0 && !string.IsNullOrWhiteSpace(thumb)) { count = 1; }
        <div class="col">
            <div class="card h-100 opacity-90 position-relative">
                @if (!string.IsNullOrWhiteSpace(thumb))
                {
                    <div class="image-wrap">
                        <img src="@thumb" class="card-img-top jersey-thumb" alt="@c.Nombre" />
                        @if (count > 0)
                        {
                            <span class="photo-badge">@count fotos</span>
                        }
                        @if (c.PrecioAnterior.HasValue && c.PrecioAnterior.Value > c.Precio)
                        {
                            var pct = (int)Math.Round((c.PrecioAnterior.Value - c.Precio) / c.PrecioAnterior.Value * 100m);
                            <span class="discount-ribbon">-@pct%</span>
                        }
                    </div>
                }
                <div class="card-body">
                    <div class="mb-2">
                        <span class="badge @(c.EsEdicionLimitada ? "bg-warning text-dark" : "bg-success")">@(c.EnStock ? "En stock" : "Encargala Ahora")</span>
                        @if (c.EsEdicionLimitada) { <span class="badge bg-danger ms-1">Edición limitada</span> }
                    </div>
                    <h5 class="card-title">@c.Equipo - @c.Temporada (@c.Tipo)</h5>
                    <p class="card-text">@c.Nombre<br/><small class="text-muted">@c.Liga - @c.Marca</small></p>
                    <div class="d-flex align-items-center justify-content-between mb-1">
                        <div>
                            @if (c.PrecioAnterior.HasValue && c.PrecioAnterior.Value > c.Precio)
                            {
                                <span class="price-old me-2">@c.PrecioAnterior.Value.ToString("C")</span>
                                <span class="price-new">@c.Precio.ToString("C")</span>
                            }
                            else
                            {
                                <span class="price-new">@c.Precio.ToString("C")</span>
                            }
                        </div>
                        <a class="btn btn-outline-primary btn-sm" asp-action="Details" asp-route-id="@c.Id">Ver detalles</a>
                    </div>
                    <a class="stretched-link" asp-action="Details" asp-route-id="@c.Id" aria-label="Ver detalles de @c.Nombre"></a>
                </div>
            </div>
        </div>
    }
        </div>
    </section>
}

@* Paginación *@
@if (Model.TotalPages > 1)
{
    var q = (string)Context.Request.Query["q"]; var liga = (string)Context.Request.Query["liga"]; var equipo = (string)Context.Request.Query["equipo"]; var temporada = (string)Context.Request.Query["temporada"]; var version = (string)Context.Request.Query["version"]; var other = (string)Context.Request.Query["other"]; var enStock = (string)Context.Request.Query["enStock"]; var talla = (string)Context.Request.Query["talla"]; var sort = (string)Context.Request.Query["sort"]; var producto = (string)Context.Request.Query["producto"]; 
    <nav aria-label="Paginación de catálogo" class="d-flex justify-content-center my-3">
        <ul class="pagination">
            @{
                var pages = new List<int>();
                var current = Model.Page;
                var last = Model.TotalPages;
                if (current > 1) pages.Add(current - 1);
                pages.Add(current);
                if (current + 1 <= last) pages.Add(current + 1);
                if (current + 2 <= last) pages.Add(current + 2);
                pages = pages.Distinct().ToList();
                pages.Sort();
                var showFirst = !pages.Contains(1) && last > 0;
                var leftEllipsis = showFirst && pages.Any() && (pages.First() - 1) > 1;
                var showLast = !pages.Contains(last) && last > 0;
                var rightEllipsis = showLast && pages.Any() && (last - pages.Last()) > 1;
            }
            <li class="page-item @(Model.Page <= 1 ? "disabled" : null)">
                <a class="page-link" asp-action="Index" asp-route-q="@q" asp-route-liga="@liga" asp-route-equipo="@equipo" asp-route-temporada="@temporada" asp-route-version="@version" asp-route-other="@other" asp-route-enStock="@enStock" asp-route-talla="@talla" asp-route-sort="@sort" asp-route-producto="@producto" asp-route-page="@(Model.Page - 1)" aria-label="Anterior">&lsaquo;</a>
            </li>
            @if (showFirst)
            {
                <li class="page-item @(1 == Model.Page ? "active" : null)">
                    <a class="page-link" asp-action="Index" asp-route-q="@q" asp-route-liga="@liga" asp-route-equipo="@equipo" asp-route-temporada="@temporada" asp-route-version="@version" asp-route-other="@other" asp-route-enStock="@enStock" asp-route-talla="@talla" asp-route-sort="@sort" asp-route-producto="@producto" asp-route-page="1">1</a>
                </li>
            }
            @if (leftEllipsis)
            {
                <li class="page-item disabled"><span class="page-link">&hellip;</span></li>
            }
            @foreach (var p in pages)
            {
                <li class="page-item @(p == Model.Page ? "active" : null)">
                    <a class="page-link" asp-action="Index" asp-route-q="@q" asp-route-liga="@liga" asp-route-equipo="@equipo" asp-route-temporada="@temporada" asp-route-version="@version" asp-route-other="@other" asp-route-enStock="@enStock" asp-route-talla="@talla" asp-route-sort="@sort" asp-route-producto="@producto" asp-route-page="@p">@p</a>
                </li>
            }
            @if (rightEllipsis)
            {
                <li class="page-item disabled"><span class="page-link">&hellip;</span></li>
            }
            @if (showLast)
            {
                <li class="page-item @(last == Model.Page ? "active" : null)">
                    <a class="page-link" asp-action="Index" asp-route-q="@q" asp-route-liga="@liga" asp-route-equipo="@equipo" asp-route-temporada="@temporada" asp-route-version="@version" asp-route-other="@other" asp-route-enStock="@enStock" asp-route-talla="@talla" asp-route-sort="@sort" asp-route-producto="@producto" asp-route-page="@last">@last</a>
                </li>
            }
            <li class="page-item @(Model.Page >= Model.TotalPages ? "disabled" : null)">
                <a class="page-link" asp-action="Index" asp-route-q="@q" asp-route-liga="@liga" asp-route-equipo="@equipo" asp-route-temporada="@temporada" asp-route-version="@version" asp-route-other="@other" asp-route-enStock="@enStock" asp-route-talla="@talla" asp-route-sort="@sort" asp-route-producto="@producto" asp-route-page="@(Model.Page + 1)" aria-label="Siguiente">&rsaquo;</a>
            </li>
        </ul>
    </nav>
}
@* Placeholder de catálogo eliminado
{
    var thumb = c.Imagenes?.OrderBy(x => x.Orden).FirstOrDefault()?.Url ?? c.ImagenUrl;
    var count = c.Imagenes?.Count ?? 0;
    if (count == 0 && !string.IsNullOrWhiteSpace(thumb)) { count = 1; }
    <div class="col">
        <div class="card h-100 position-relative">
            @if (!string.IsNullOrWhiteSpace(thumb))
            {
                <div class="image-wrap">
                    <img src="@thumb" class="card-img-top jersey-thumb" alt="@c.Nombre" />
                    @if (count > 0)
                    {
                        <span class="photo-badge">@count fotos</span>
                    }
                </div>
            }
            <div class="card-body">
                <h5 class="card-title">@c.Equipo - @c.Temporada (@c.Tipo)</h5>
                <p class="card-text">@c.Nombre<br/><small class="text-muted">@c.Liga Â· @c.Marca</small></p>
                <a class="btn btn-outline-primary btn-sm" asp-action="Details" asp-route-id="@c.Id">Ver detalles</a>
                <a class="stretched-link" asp-action="Details" asp-route-id="@c.Id" aria-label="Ver detalles de @c.Nombre"></a>
            </div>
        </div>
    </div>
}
*@

@if (!Model.Camisetas.Any())
{
    <div class="text-center py-5">
        <h4 class="mb-3">Estamos trabajando para conseguir tu camiseta</h4>
        <p class="mb-1">Consultanos por Instagram o WhatsApp</p>
        <div class="d-flex gap-2 justify-content-center">
            <a class="btn btn-outline-success" href="https://wa.me/5493816658972" target="_blank" rel="noopener">WhatsApp</a>
            <a class="btn btn-outline-primary" href="https://www.instagram.com/clasicodelgol.tuc/" target="_blank" rel="noopener">&#64;clasicodelgol.tuc</a>
        </div>
    </div>
}
